# Reusable workflow for generating Buck2 files
#
# This workflow:
# 1. Sets up the build environment on 3 platforms (linux/macos/windows)
# 2. Installs cargo-buckal and Buck2
# 3. Generates Buck2 files for the target project
# 4. Uploads artifacts for the test phase

name: Generate Buck2 Targets

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name for artifact naming (e.g., fd, libra, cargo-buckal)'
        required: true
        type: string
      clone_url:
        description: 'Git URL to clone (leave empty for self-test)'
        required: false
        type: string
        default: ''
      clone_ref:
        description: 'Git ref (branch/tag) to clone'
        required: false
        type: string
        default: 'main'
      project_dir:
        description: 'Directory name for the project (defaults to project_name)'
        required: false
        type: string
        default: ''
      clean_existing_buck2_and_buckal:
        description: 'Clean existing Buck2/Buckal files before generating'
        required: false
        type: boolean
        default: false
      set_ignore_tests_false:
        description: 'Ensure buckal.toml contains ignore_tests = false before generation'
        required: false
        type: boolean
        default: false
      apply_patches:
        description: 'Apply patches from .github/patches/{project_name}/ after generation'
        required: false
        type: boolean
        default: false

jobs:
  generate_buck2_files:
    name: generate (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-24.04
          - name: macos
            os: macos-14
          - name: windows
            os: windows-2022

    steps:
      - name: Set cargo target dir
        shell: bash
        env:
          RUNNER_TEMP: ${{ runner.temp }}
        run: echo "CARGO_TARGET_DIR=$RUNNER_TEMP/cargo-target" >> "$GITHUB_ENV"

      - name: Checkout cargo-buckal
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          path: cargo-buckal

      - name: Setup Windows environment
        uses: ./cargo-buckal/.github/actions/setup-windows

      - name: Clone ${{ inputs.project_name }} ${{ inputs.clone_ref }}
        if: inputs.clone_url != ''
        shell: bash
        env:
          CLONE_REF: ${{ inputs.clone_ref }}
          CLONE_URL: ${{ inputs.clone_url }}
          PROJECT_DIR: ${{ inputs.project_dir || inputs.project_name }}
        run: |
          git clone --depth 1 --branch "$CLONE_REF" "$CLONE_URL" "$PROJECT_DIR"

      - name: Setup Rust toolchains
        uses: ./cargo-buckal/.github/actions/setup-rust-toolchains

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            cargo-buckal -> target
          cache-all-crates: true

      - name: Install Buck2
        uses: ./cargo-buckal/.github/actions/install-buck2

      - name: Install cargo-buckal
        shell: bash
        run: |
          cd cargo-buckal
          cargo install --locked --path .

      # For external projects, clean up existing Buck2/Buckal files and reinitialize
      - name: Clean up existing Buck2/Buckal files
        if: inputs.clean_existing_buck2_and_buckal
        shell: bash
        env:
          PROJECT_DIR: ${{ inputs.project_dir || inputs.project_name }}
        run: |
          cd "$PROJECT_DIR"
          rm -f buckal.snap .buckconfig .buckroot BUCK
          rm -rf third-party toolchains platforms

      - name: Configure buckal.toml ignore_tests
        if: inputs.set_ignore_tests_false
        shell: bash
        env:
          PROJECT_DIR: ${{ inputs.project_dir || inputs.project_name }}
        run: |
          cd "$PROJECT_DIR"
          touch buckal.toml
          if ! grep -q '^ignore_tests = false$' buckal.toml; then
            echo 'ignore_tests = false' >> buckal.toml
          fi

      - name: Generate Buck2 files
        shell: bash
        env:
          PROJECT_DIR: ${{ inputs.project_dir || inputs.project_name || 'cargo-buckal' }}
        run: |
          cd "$PROJECT_DIR"
          cargo buckal migrate --init

      - name: Apply patches
        if: inputs.apply_patches
        shell: bash
        env:
          PROJECT_DIR: ${{ inputs.project_dir || inputs.project_name }}
          PROJECT_NAME: ${{ inputs.project_name }}
        run: |
          cd "$PROJECT_DIR"
          PATCH_DIR="../cargo-buckal/.github/patches/$PROJECT_NAME"
          if [[ -d "$PATCH_DIR" ]]; then
            echo "Applying patches from $PATCH_DIR"
            # Apply .patch files
            for patch in "$PATCH_DIR"/*.patch; do
              if [[ -f "$patch" ]]; then
                echo "Applying patch: $patch"
                git apply "$patch" || patch -p1 < "$patch"
              fi
            done
            # Run .sh scripts
            for script in "$PATCH_DIR"/*.sh; do
              if [[ -f "$script" ]]; then
                echo "Running script: $script"
                chmod +x "$script"
                bash "$script"
              fi
            done
          else
            echo "No patches directory found at $PATCH_DIR"
          fi

      - name: Upload generated tree
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.project_name }}-gen-${{ matrix.name }}
          path: ${{ inputs.project_dir || inputs.project_name || 'cargo-buckal' }}
          if-no-files-found: error
          include-hidden-files: true
