name: Gemini AI Code Review

on:
  # 关键修改：改用 pull_request_target
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'LICENSE'
      - '**/*.lock'

permissions:
  contents: read      # 读取代码
  pull-requests: write # 允许 AI 发表评论

jobs:
  ai_review:
    runs-on: ubuntu-latest
    name: "Gemini Code Auditor"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # 关键配置：必须显式拉取 PR 的代码（head），否则默认拉取的是主分支代码
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          
      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: |
          pip install google-generativeai requests
          # 如果有其他依赖
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Execute Review Script
        env:
          # 在 pull_request_target 模式下，这里可以正常拿到 Secret
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          # 此时 BASE_SHA 是你主分支的 target，HEAD_SHA 是贡献者的提交
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: python .github/scripts/review_agent.py